[%# This Source Code Form is subject to the terms of the Mozilla Public
  # License, v. 2.0. If a copy of the MPL was not distributed with this
  # file, You can obtain one at http://mozilla.org/MPL/2.0/.
  #
  # Copyright (C) 2014-2017 Jolla Ltd.
  # Contact: Pami Ketolainen <pami.ketolainen@jolla.com>
  #%]

[% bug_templates = [
  'bug/show.html.tmpl',
  'bug/create/created.html.tmpl',
  'bug/process/results.html.tmpl'
  ] %]
[% IF bug_templates.contains(template.name) %]
  <style type="text/css">
    li.remotetrack-url {
      font-weight: bold;
      background-color: lightgray;
      border-radius: 5px;
      padding: 5px 0px;
    }
  </style>
  <script type="text/javascript">
    var REMOTETRACK_URL = "[% bug.remotetrack_url FILTER js %]";

  [% IF user.in_group(Param('remotetrack_group')) %]
    var REMOTETRACK_MANUALSYNC = [% Param('remotetrack_manual_sync') ? 'true' : 'false' %];
    var addRemoteTrackUrlSwitch = function(item, url) {
      var input = $("<input>")
        .attr("type", "radio")
        .attr("name", "remotetrack_url")
        .attr("value", url);
      if (REMOTETRACK_URL == url) {
        input.attr("checked", "checked");
        if (url) {
          item.addClass('remotetrack-url');
        }
      }
      var label = $("<label>").append(input).append(url ? "Track" : "No tracking");
      item.append(label);

      if (REMOTETRACK_MANUALSYNC && url && url == REMOTETRACK_URL) {
        item.append(" ").append(
          $('<a>')
            .attr('href', "page.cgi?id=rt_manual_sync.html&amp;bug_id=[% bug.id %]")
            .text('Manual sync')
        );
      }
    }

    $(function() {
      var seeAlsoUrls = [];
      $("ul.bug_urls > li").each(function() {
        var item = $(this);
        var url = item.find("a").first().attr('href');
        seeAlsoUrls.push(url);
      })

      if(seeAlsoUrls.length == 0) return;

      new Rpc("RemoteTrack", "valid_urls", {urls: seeAlsoUrls})
      .done(function(result) {
        result.forEach(function(url) {
          var link = $("ul.bug_urls a[href='" + url +"']");
          if (link.size() == 0) return;
          addRemoteTrackUrlSwitch(link.parent(), url);
        })
        if(result.length > 0) {
          var noTrackLi = $("<li>");
          $("ul.bug_urls").append(noTrackLi);
          addRemoteTrackUrlSwitch(noTrackLi, "");
        }
      })
    })

  [% ELSE %]

  $(function() {
    if (!REMOTETRACK_URL) return;
    $("ul.bug_urls > li").each(function() {
      var item = $(this);
      if (item.find('a').first().attr('href') == REMOTETRACK_URL) {
        item.addClass('remotetrack-url').append(" Tracked");
        item.append(
          $('<input>').attr('name', 'remotetrack_url')
                    .attr('type', 'hidden')
                    .attr('value', REMOTETRACK_URL)
        );
        return false;
      }
    });
  })

  [% END %]
  </script>
[% END %]

